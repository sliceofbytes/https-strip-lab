worker_processes auto;
events { worker_connections 1024; }
http {
  resolver 127.0.0.11 ipv6=off valid=30s;

  # rewrite https://<host>/... to http://<same-host>/...
  map $upstream_http_location $rewritten_location {
    default $upstream_http_location;
    ~^https://([^/]+)(/?.*)$ http://$1$2;
  }

  server {
    listen 80;
    server_name _;

    location / {
      proxy_pass https://upstream:443;
      proxy_ssl_server_name on;
      proxy_ssl_name upstream;     # SNI for the upstream name
      proxy_ssl_verify off;        # self-signed in this lab

      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header Content-Security-Policy;

      proxy_redirect off;
      proxy_set_header Host $host;           # preserve the public host
      proxy_set_header X-Forwarded-Proto http;

      proxy_intercept_errors on;
      error_page 301 302 307 308 = @handle_redirect;
    }

    location @handle_redirect {
      internal;
      add_header Location $rewritten_location always;
      return 302;
    }
  }
}
