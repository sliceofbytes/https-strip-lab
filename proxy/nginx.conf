worker_processes auto;
events { worker_connections 1024; }
http {
  resolver 127.0.0.11 ipv6=off valid=30s;  # Docker DNS

  # rewrite https://<host>/... to http://<same-host>/...
  map $upstream_http_location $rewritten_location {
    default $upstream_http_location;
    ~^https://([^/]+)(/?.*)$ http://$1$2;
  }

  # use a variable so DNS happens at request time (not startup)
  map "" $u_host { default "upstream"; }

  server {
    listen 80;
    server_name _;

    location / {
      proxy_pass https://$u_host:443;   # <-- variable form
      proxy_ssl_server_name on;
      proxy_ssl_name $u_host;
      proxy_ssl_verify off;

      proxy_hide_header Strict-Transport-Security;
      proxy_hide_header Content-Security-Policy;

      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto http;

      proxy_intercept_errors on;
      error_page 301 302 307 308 = @handle_redirect;
    }

    location @handle_redirect {
      internal;
      add_header Location $rewritten_location always;
      return 302;
    }
  }
}
